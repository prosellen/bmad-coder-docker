name: Deploy Images to GHCR

on:
  # # This is un 
  # push:
  #   branches:
  #     - main
  #   paths-ignore:
  #     - '.vscode/**'
  #     - '**/*.md'
  #     - '.github/workflows/**'
  release:
    types: [published]
  # workflow_run:
  #   workflows: ["Release"]
  #   types: [completed]
  workflow_dispatch:

jobs:
  push-store-image:
    runs-on: ubuntu-latest
    permissions:
      packages: write
      contents: read
    defaults:
      run:
        working-directory: '.'
    steps:
      - name: 'Checkout GitHub Action'
        uses: actions/checkout@main
        with:
          fetch-depth: 0
          # For release events, checkout the release tag; for workflow_dispatch, use the default branch
          ref: ${{ github.event_name == 'release' && github.event.release.tag_name || '' }}

      - name: Determine image tag
        id: image_tag
        env:
          GITHUB_TOKEN: ${{ github.token }}
        run: |
          if [ "${{ github.event_name }}" = "release" ] && [ -n "${{ github.event.release.tag_name }}" ]; then
            TAG="${{ github.event.release.tag_name }}"
          else
            TAG="latest"
          fi
          echo "tag=${TAG}" >> $GITHUB_OUTPUT
          echo "Image will be tagged as: ${TAG}"

      - name: 'Login to GitHub Container Registry'
        uses: docker/login-action@v1
        with:
          registry: ghcr.io
          username: ${{github.actor}}
          password: ${{secrets.GHCR_TOKEN_WRITE}} 

      # - name: 'Build Docker Image'
      #   run: |
      #     docker build . --platform linux/amd64,linux/arm64 --tag ghcr.io/bmad-method-test-project/bmad-coder-docker:latest
      
      # - name: 'Push Docker Image to GHCR'
      #   run: |
      #     docker push ghcr.io/bmad-method-test-project/bmad-coder-docker:latest

      # This allows you to build for ARM on an AMD64 runner
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
            
      # This allows you to build for ARM on an AMD64 runner
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push v4 image
        uses: docker/build-push-action@v5
        with:
          context: .
          platforms: linux/amd64,linux/arm64
          push: true
          build-args: |
            BMAD_VERSION=4
          tags: |
            ghcr.io/bmad-method-test-project/bmad-coder-docker-v4:latest
            ghcr.io/bmad-method-test-project/bmad-coder-docker-v4:${{ steps.image_tag.outputs.tag }}

      - name: Build and push v6 image
        uses: docker/build-push-action@v5
        with:
          context: .
          platforms: linux/amd64,linux/arm64
          push: true
          build-args: |
            BMAD_VERSION=6
          tags: |
            ghcr.io/bmad-method-test-project/bmad-coder-docker-v6:latest
            ghcr.io/bmad-method-test-project/bmad-coder-docker-v6:${{ steps.image_tag.outputs.tag }}        