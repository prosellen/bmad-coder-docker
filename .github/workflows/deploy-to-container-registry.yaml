name: Deploy Images to GHCR

on:
  push:
    branches:
      - main
    paths-ignore:
      - '.vscode/**'
      - '**/*.md'
      - '.github/workflows/**'
  release:
    types: [published]
  workflow_run:
    workflows: ["Release"]
    types: [completed]
  workflow_dispatch:

jobs:
  push-store-image:
    runs-on: ubuntu-latest
    permissions:
      packages: write
      contents: read
    # Only run on successful Release workflow when triggered by workflow_run
    if: ${{ github.event_name != 'workflow_run' || github.event.workflow_run.conclusion == 'success' }}
    defaults:
      run:
        working-directory: '.'
    steps:
      - name: 'Checkout GitHub Action'
        uses: actions/checkout@main
        with:
          fetch-depth: 0
          # Use the exact source for each event type
          # - release: checkout the release tag
          # - push: checkout main
          # - workflow_run: checkout the head_sha from the Release workflow
          ref: ${{ github.event_name == 'release' && github.event.release.tag_name || (github.event_name == 'push' && 'main' || github.event.workflow_run.head_sha) }}

      - name: Determine image tag
        id: image_tag
        env:
          GITHUB_TOKEN: ${{ github.token }}
        run: |
          if [ "${{ github.event_name }}" = "release" ] && [ -n "${{ github.event.release.tag_name }}" ]; then
            TAG="${{ github.event.release.tag_name }}"
          elif [ "${{ github.event_name }}" = "workflow_run" ]; then
            # Fetch latest release tag from GitHub API
            TAG=$(curl -s -H "Authorization: Bearer ${GITHUB_TOKEN}" \
              -H "Accept: application/vnd.github+json" \
              "https://api.github.com/repos/${GITHUB_REPOSITORY}/releases/latest" | jq -r '.tag_name // "latest"')
          else
            TAG="latest"
          fi
          echo "tag=${TAG}" >> $GITHUB_OUTPUT
          echo "Image will be tagged as: ${TAG}"

      - name: 'Login to GitHub Container Registry'
        uses: docker/login-action@v1
        with:
          registry: ghcr.io
          username: ${{github.actor}}
          password: ${{secrets.GITHUB_TOKEN}}

      # - name: 'Build Docker Image'
      #   run: |
      #     docker build . --platform linux/amd64,linux/arm64 --tag ghcr.io/bmad-method-test-project/bmad-coder-docker:latest
      
      # - name: 'Push Docker Image to GHCR'
      #   run: |
      #     docker push ghcr.io/bmad-method-test-project/bmad-coder-docker:latest

      # This allows you to build for ARM on an AMD64 runner
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
            
      # This allows you to build for ARM on an AMD64 runner
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: .
          platforms: linux/amd64,linux/arm64
          push: true
          tags: |
            ghcr.io/bmad-method-test-project/bmad-coder-docker:latest
            ghcr.io/bmad-method-test-project/bmad-coder-docker:${{ steps.image_tag.outputs.tag }}        